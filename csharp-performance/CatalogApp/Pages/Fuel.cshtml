@page
@model CatalogApp.Pages.FuelModel

<h1>Fuel Price Checker</h1>

<div class="mb-3">
    <label for="AirportCode" class="form-label">Airport Code:</label>
    <input id="AirportCode" class="form-control w-25 d-inline" maxlength="4" value="KDFW" />
    <button id="getPriceBtn" class="btn btn-success ms-2">Get Fuel Price</button>
</div>

<hr />

<div id="loading" class="text-center mt-4 d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Fetching fuel price...</p>
</div>

<div id="result" class="d-none alert alert-success">
    <h4 id="airport"></h4>
    <h2 id="price"></h2>
    <p><strong>Status:</strong> <span id="status"></span></p>
    <small id="timestamp"></small>
</div>

<div id="error" class="d-none alert alert-danger"></div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/9.0.6/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/fuelStatusHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveFuelUpdate", data => {
            document.getElementById("loading").classList.add("d-none");

            if (data.status === "complete" && data.result) {
                document.getElementById("result").classList.remove("d-none");
                document.getElementById("airport").innerText = data.airportCode + " Fuel Price";
                document.getElementById("price").innerText = "$" + data.result.fuelPriceUsdPerGallon.toFixed(2);
                document.getElementById("status").innerText = "Success";
            } else if (data.status.startsWith("error")) {
                document.getElementById("error").classList.remove("d-none");
                document.getElementById("error").innerText = data.errorMessage || "Failed to fetch fuel price.";
            }
        });

        connection.start().catch(err => console.error("SignalR connection failed:", err));

        // Button click handler
        document.getElementById("getPriceBtn").addEventListener("click", async () => {
            const airportCode = document.getElementById("AirportCode").value.trim().toUpperCase();
            if (!airportCode) {
                alert("Please enter an airport code");
                return;
            }

            // Show loading
            document.getElementById("loading").classList.remove("d-none");
            document.getElementById("result").classList.add("d-none");
            document.getElementById("error").classList.add("d-none");

            // Call backend API (fire-and-forget)
            try {
                await fetch('/api/fuel/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ airportCode })
                });
                // SignalR will push the result when ready
            } catch (err) {
                console.error("Fetch error:", err);
            }
        });
    </script>
}